<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OCR â€“ Ã“rdenes de Venta (Smart v4.9.0)</title>
<style>
:root{
  --accent:#00ff88;
  --bg:#0b1220;
  --text:#f5f5f5;
  --muted:#999;
}
body{
  font-family:Arial,Helvetica,sans-serif;
  background:var(--bg);
  color:var(--text);
  margin:0;
  padding:0;
  text-align:center;
}
header{padding:12px;}
button{
  background:var(--accent);
  color:#000;
  border:none;
  border-radius:8px;
  padding:10px 16px;
  margin:6px;
  font-size:15px;
  cursor:pointer;
}
button.ghost{
  background:transparent;
  border:1px solid var(--accent);
  color:var(--accent);
}
video{
  width:100%;
  height:auto;
  border-radius:8px;
  object-fit:cover;
  transform:rotate(0deg);
}
#overlay{
  position:absolute;
  top:0;left:0;
  width:100%;height:100%;
  pointer-events:none;
}
#frame{
  position:absolute;
  border:3px solid var(--accent);
  border-radius:12px;
  width:92%;
  height:80%;
  top:10%;
  left:4%;
  box-sizing:border-box;
}
#handle{
  position:absolute;
  bottom:-8px;left:50%;
  width:80px;height:10px;
  background:rgba(200,200,200,0.7);
  border-radius:5px;
  cursor:ns-resize;
  transform:translateX(-50%);
}
#canvasPreview{
  border:1px dashed #777;
  margin-top:10px;
  max-width:90%;
}
table{
  margin:20px auto;
  border-collapse:collapse;
  width:95%;
  max-width:800px;
}
th,td{
  border:1px solid #777;
  padding:6px;
  font-size:13px;
  text-align:left;
}
th{background:#111;color:#eee;}
footer{margin:20px;font-size:12px;color:var(--muted);}
</style>
</head>
<body>

<header>
  <h2>OCR â€“ Ã“rdenes de Venta (Smart v4.9.0)</h2>
  <div>CÃ¡mara horizontal (botÃ³n volumen arriba) + OCR 2 columnas</div>
</header>

<main>
  <button id="btnStart">ðŸ“· Tomar foto / Subir imagen</button>
  <button id="btnClear" class="ghost">ðŸ§¹ Limpiar</button>

  <div style="position:relative;display:inline-block;margin-top:10px;">
    <video id="video" autoplay playsinline></video>
    <div id="overlay">
      <div id="frame">
        <div id="handle"></div>
      </div>
    </div>
  </div>

  <h3>Vista previa (recorte exacto del marco)</h3>
  <canvas id="canvasPreview"></canvas>

  <h3>Tabla OCR generada</h3>
  <table id="tablaOCR">
    <thead>
      <tr><th>DescripciÃ³n</th><th>Cantidades</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<footer>Smart OCR Horizontal Â© 2025 Calidad Sede Villa</footer>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
<script>
// === InicializaciÃ³n de cÃ¡mara y marco ===
const video=document.getElementById('video');
const frame=document.getElementById('frame');
const handle=document.getElementById('handle');
let stream,frameHeight=0.8; // proporciÃ³n inicial de altura

// Activar cÃ¡mara trasera
async function startCamera(){
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  video.srcObject=stream;
}

// Redimensionar marco con el tirador inferior
let resizing=false,startY=0;
handle.addEventListener('mousedown',e=>{resizing=true;startY=e.clientY;});
window.addEventListener('mouseup',()=>resizing=false);
window.addEventListener('mousemove',e=>{
  if(!resizing)return;
  const delta=(e.clientY-startY)/window.innerHeight;
  frameHeight=Math.max(0.4,Math.min(0.9,frameHeight+delta));
  frame.style.height=(frameHeight*100)+'%';
  startY=e.clientY;
});

// === Captura del Ã¡rea exacta dentro del marco verde ===
async function captureAndProcess(){
  const w=video.videoWidth,h=video.videoHeight;
  const c=document.createElement('canvas');
  const ctx=c.getContext('2d');
  c.width=w;c.height=h;
  ctx.drawImage(video,0,0,w,h);

  // coordenadas proporcionales exactas al marco
  const fx=0.04*w;
  const fy=(1-frameHeight)/2*h;
  const fw=0.92*w;
  const fh=frameHeight*h;
  const rec=ctx.getImageData(fx,fy,fw,fh);

  // crear recorte
  const crop=document.createElement('canvas');
  crop.width=fw;crop.height=fh;
  crop.getContext('2d').putImageData(rec,0,0);

  // mostrar vista previa
  const prev=document.getElementById('canvasPreview');
  prev.width=fw;prev.height=fh;
  prev.getContext('2d').putImageData(rec,0,0);

  // OCR con solo columnas 1 (desc) y 3 (cant)
  await procesarOCR(crop);
}

// === OCR principal ===
async function procesarOCR(canvas){
  const {data:{text}}=await Tesseract.recognize(canvas,'spa',{logger:m=>console.log(m.status)});
  const lineas=text.split('\n').map(l=>l.trim()).filter(Boolean);

  // Filtrado: solo mantener lÃ­neas que parecen tener nÃºmero al final
  const data=lineas.map(l=>{
    const match=l.match(/(.*?)(\d{1,4})$/);
    if(match)return{desc:match[1].trim(),cant:match[2].trim()};
  }).filter(Boolean);

  // Mostrar tabla
  const tbody=document.querySelector('#tablaOCR tbody');
  tbody.innerHTML="";
  data.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.desc}</td><td>${r.cant}</td>`;
    tbody.appendChild(tr);
  });
}

// === Botones ===
document.getElementById('btnStart').onclick=async()=>{
  await startCamera();
  captureAndProcess(); // captura instantÃ¡nea
};
document.getElementById('btnClear').onclick=()=>{
  const ctx=document.getElementById('canvasPreview').getContext('2d');
  ctx.clearRect(0,0,9999,9999);
  document.querySelector('#tablaOCR tbody').innerHTML="";
};
</script>
</body>
</html>
