<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Calidad Sede Villa â€“ OCR Horizontal v4.3.1</title>
<meta name="theme-color" content="#ffffff"/>
<link rel="manifest" href="manifest.json"/>

<style>
:root {
  color-scheme: light dark;
  --accent:#0b1220;
  --ok:#28a745;
  --error:#c00;
}
@media (prefers-color-scheme: light) {
  :root {
    --bg:#ffffff;
    --text:#222;
    --muted:#777;
    --card:#f7f7f7;
  }
}
@media (prefers-color-scheme: dark) {
  :root {
    --bg:#0b1220;
    --text:#f2f2f2;
    --muted:#aaa;
    --card:#18212e;
  }
}

body{
  font-family:Arial,Helvetica,sans-serif;
  margin:0;padding:0;
  background:var(--bg);
  color:var(--text);
}
header{
  background:var(--card);
  border-bottom:2px solid var(--accent);
  padding:10px 15px;
  text-align:center;
}
h1{margin:4px 0;font-size:20px;}
.sub{font-size:14px;color:var(--muted);}
main{
  padding:15px;
  text-align:center;
}
button{
  background:var(--accent);
  color:#fff;
  border:none;
  border-radius:8px;
  padding:10px 14px;
  margin:5px;
  cursor:pointer;
  font-size:14px;
}
button.ghost{
  background:transparent;
  color:var(--accent);
  border:1px solid var(--accent);
}
canvas{
  border:1px dashed var(--muted);
  max-width:90%;
  margin-top:8px;
}
.tip{
  font-size:13px;
  color:var(--muted);
  margin-top:8px;
}
footer{
  margin-top:20px;
  font-size:12px;
  color:var(--muted);
}
#tablaOCR {
  margin:20px auto;
  border-collapse:collapse;
  width:95%;
  max-width:800px;
}
#tablaOCR th,#tablaOCR td{
  border:1px solid #aaa;
  padding:6px;
  text-align:left;
  font-size:13px;
}
#tablaOCR th{
  background:var(--card);
}
</style>
</head>
<body>

<header>
  <h1>OCR â€“ Ã“rdenes de Venta (Smart v4.3.1)</h1>
  <div class="sub">Calidad Sede Villa â€“ OCR Horizontal con tabla ordenada</div>
</header>

<main>
  <div>
    <button id="fileBtn">ðŸ“· Tomar foto / Subir imagen</button>
    <input type="file" id="file" accept="image/*" capture="environment" style="display:none"/>
    <button id="btnClear" class="ghost">ðŸ§¹ Limpiar</button>
  </div>

  <h4>Vista previa (autocorrecciÃ³n leve)</h4>
  <canvas id="canvas"></canvas>
  <div class="tip">
    Tip: encuadra la <b>tabla</b> horizontalmente, con buena luz y perpendicular.
  </div>

  <h4>Tabla OCR generada</h4>
  <table id="tablaOCR">
    <thead>
      <tr><th>NÂ°</th><th>DescripciÃ³n</th><th>Cant.</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<footer>
  <div>Smart OCR Horizontal v4.3.1 Â© 2025 Calidad Sede Villa</div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
<script>
function toggleLoading(state){ document.body.style.cursor = state ? "wait" : "default"; }

function createCanvas(w,h){const c=document.createElement('canvas');c.width=w;c.height=h;return c;}
function drawRotated(srcCanvas,deg){
  const rad=deg*Math.PI/180;
  let w=srcCanvas.width,h=srcCanvas.height;
  const rotated=(Math.abs(deg)%180===90);
  const out=createCanvas(rotated?h:w,rotated?w:h);
  const ctx=out.getContext('2d');
  ctx.translate(out.width/2,out.height/2);
  ctx.rotate(rad);
  ctx.drawImage(srcCanvas,-w/2,-h/2);
  return out;
}
async function getExifOrientation(file){
  try{
    const buf=await file.arrayBuffer();const view=new DataView(buf);
    if(view.getUint16(0,false)!==0xFFD8)return null;
    let offset=2;
    while(offset<view.byteLength){
      const marker=view.getUint16(offset,false);offset+=2;
      if(marker===0xFFE1){
        const len=view.getUint16(offset,false);offset+=2;
        if(view.getUint32(offset,false)!==0x45786966)return null;
        offset+=6;const little=view.getUint16(offset,false)===0x4949;
        offset+=2;const firstIFD=view.getUint32(offset,little);offset+=4;
        let ifdOffset=(offset-4)+firstIFD;
        const entries=view.getUint16(ifdOffset,little);ifdOffset+=2;
        for(let i=0;i<entries;i++){
          const entryOffset=ifdOffset+i*12;
          const tag=view.getUint16(entryOffset,little);
          if(tag===0x0112){
            const val=view.getUint16(entryOffset+8,little);
            return val;
          }
        }return null;
      }else if((marker&0xFF00)!==0xFF00){break;}
      else{const len=view.getUint16(offset,false);offset+=len;}
    }return null;
  }catch(_){return null;}
}
async function fileToCanvasWithExif(file){
  const imgURL=URL.createObjectURL(file);
  const img=await new Promise((res,rej)=>{
    const i=new Image();i.onload=()=>res(i);i.onerror=rej;i.src=imgURL;
  });
  let base=createCanvas(img.naturalWidth||img.width,img.naturalHeight||img.height);
  base.getContext('2d').drawImage(img,0,0,base.width,base.height);
  const orientation=await getExifOrientation(file);
  if(orientation===6)base=drawRotated(base,90);
  else if(orientation===8)base=drawRotated(base,-90);
  else if(orientation===3)base=drawRotated(base,180);
  if(base.height>base.width)base=drawRotated(base,90);
  URL.revokeObjectURL(imgURL);
  return base;
}

async function detectarTablaYCortarColumnas(baseCanvas){
  const w=baseCanvas.width,h=baseCanvas.height;
  const colN=[0.02*w,0.13*w];
  const colDes=[0.24*w,0.79*w];
  const colCant=[0.88*w,0.97*w];
  const columnas=[
    {nombre:"NÂ°",rango:colN},
    {nombre:"DescripciÃ³n",rango:colDes},
    {nombre:"Cant.",rango:colCant}
  ];

  const resultados = [];

  for(const col of columnas){
    const cw=col.rango[1]-col.rango[0];
    const ch=h*0.93;
    const c=createCanvas(cw,ch);
    c.getContext('2d').drawImage(baseCanvas,col.rango[0],h*0.05,cw,ch,0,0,cw,ch);
    const { data:{ text } } = await Tesseract.recognize(c,'spa',{logger:m=>console.log(m.status)});
    resultados.push(text.trim());
  }

  mostrarTabla(resultados);
}

function mostrarTabla(textos){
  const [colN,colDes,colCant]=textos.map(t=>t.split(/\n+/).filter(Boolean));
  const tbody=document.querySelector("#tablaOCR tbody");
  tbody.innerHTML="";
  const filas=Math.max(colN.length,colDes.length,colCant.length);
  for(let i=0;i<filas;i++){
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${colN[i]||''}</td>
      <td>${colDes[i]||''}</td>
      <td>${colCant[i]||''}</td>`;
    tbody.appendChild(tr);
  }
}

async function loadAndDraw(file){
  try{
    toggleLoading(true);
    const baseCanvas=await fileToCanvasWithExif(file);
    const preview=document.getElementById('canvas');
    preview.width=baseCanvas.width;preview.height=baseCanvas.height;
    preview.getContext('2d').drawImage(baseCanvas,0,0);
    await detectarTablaYCortarColumnas(baseCanvas);
  }catch(err){
    alert('Error procesando imagen.');
    console.error(err);
  }finally{
    toggleLoading(false);
  }
}

document.getElementById('fileBtn').onclick=()=>document.getElementById('file').click();
document.getElementById('file').onchange=e=>{
  const f=e.target.files?.[0];if(f)loadAndDraw(f);
};
document.getElementById('btnClear').onclick=()=>{
  document.getElementById('canvas').getContext('2d').clearRect(0,0,9999,9999);
  document.querySelector("#tablaOCR tbody").innerHTML="";
};
</script>

</body>
</html>
