<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Calidad Sede Villa ‚Äì OCR Horizontal v4.8.7</title>
  <meta name="theme-color" content="#ffffff"/>

  <!-- Smart OCR v4.8.7
       - Rotaci√≥n fija -90¬∞ (modo horizontal, bot√≥n volumen arriba)
       - Deskew centrado + crop a contenido
       - OCR 3 columnas (N¬∞, Descripci√≥n, Cantidades)
       - Recorte vertical Y_TABLE=[0.20,0.93]
       - Sharpen + contraste
       - Guarda vista previa en localStorage + descarga
  -->

  <style>
    :root{color-scheme:light dark;--accent:#0b1220;--muted:#777;--bg:#fff;--text:#222;--card:#f7f7f7;}
    @media (prefers-color-scheme:dark){:root{--bg:#0b1220;--text:#f2f2f2;--muted:#aaa;--card:#18212e;}}
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    header{background:var(--card);border-bottom:2px solid var(--accent);padding:10px 15px;text-align:center}
    h1{margin:2px 0 0;font-size:20px}
    .version{display:block;margin-top:2px;font-size:12px;color:var(--muted)}
    main{padding:15px;text-align:center}
    button{background:var(--accent);color:#fff;border:none;border-radius:12px;padding:10px 16px;margin:5px;cursor:pointer;font-size:15px}
    button.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent)}
    canvas{border:1px dashed var(--muted);max-width:90%;margin-top:8px}
    #tablaOCR{margin:20px auto;border-collapse:collapse;width:95%;max-width:900px}
    #tablaOCR th,#tablaOCR td{border:1px solid #aaa;padding:6px;text-align:left;font-size:13px}
    #tablaOCR th{background:var(--card)}
    .tip{font-size:13px;color:var(--muted);margin-top:8px}
    .small{font-size:12px;color:var(--muted);margin-top:6px}

    /* --- UI c√°mara a pantalla completa --- */
    #cameraModal{position:fixed;inset:0;background:#000;display:none;align-items:center;justify-content:center;z-index:9999}
    .cam-wrap{position:relative;width:100vw;height:100vh;background:#000;overflow:hidden}
    #video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .crop-box{
      position:absolute;left:50%;top:50%;width:90%;height:90%;transform:translate(-50%,-50%);
      border:3px solid #00ff7b;border-radius:14px;box-shadow:0 0 0 2px rgba(0,0,0,.35),0 0 18px rgba(0,255,123,.25);
    }
    .cam-controls{position:absolute;left:0;right:0;bottom:22px;display:flex;gap:14px;justify-content:center;align-items:center}
    #snapBtn{font-size:20px;padding:20px 34px;border-radius:18px;box-shadow:0 12px 36px rgba(0,0,0,.4);backdrop-filter:blur(8px);background:rgba(11,18,32,.92)}
    #closeBtn{position:absolute;top:16px;right:16px;background:rgba(11,18,32,.72);padding:8px 12px;border-radius:12px}
    .hint{position:absolute;left:0;right:0;top:16px;color:#fff;text-align:center;font-size:16px;text-shadow:0 1px 3px rgba(0,0,0,.7)}
  </style>
</head>
<body>
  <header>
    <h1>Calidad Sede Villa ‚Äì OCR Horizontal</h1>
    <span class="version">Versi√≥n 4.8.7 ‚Äì C√°mara trasera calibrada</span>
  </header>

  <main>
    <div>
      <button id="fileBtn">üì∑ Tomar foto / Subir imagen</button>
      <input type="file" id="file" accept="image/*" capture="environment" style="display:none"/>
      <button id="btnClear" class="ghost">üßπ Limpiar</button>
      <button id="btnDownload" class="ghost" title="Descargar la √∫ltima vista previa guardada">‚¨áÔ∏è Descargar previa</button>
    </div>

    <h4>Vista previa (alineada)</h4>
    <canvas id="canvas"></canvas>
    <div class="tip">Alineado autom√°ticamente al eje horizontal (vista real del documento).</div>
    <div class="small" id="debugInfo"></div>

    <h4>Tabla OCR generada</h4>
    <table id="tablaOCR">
      <thead><tr><th>N¬∞</th><th>Descripci√≥n</th><th>Cantidades</th></tr></thead>
      <tbody></tbody>
    </table>
  </main>

  <footer><div class="small">Smart OCR ¬© 2025</div></footer>

  <!-- Tesseract -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>

  <script>
    /* ===== Utilidades canvas ===== */
    function toggleLoading(s){document.body.style.cursor=s?"wait":"default";}
    function createCanvas(w,h){const c=document.createElement('canvas');c.width=w;c.height=h;return c;}
    function putCanvas(src){const p=document.getElementById('canvas');p.width=src.width;p.height=src.height;p.getContext('2d').drawImage(src,0,0);}
    function drawRotated(src,deg){ // rotaci√≥n sobre centro
      const r=deg*Math.PI/180,w=src.width,h=src.height,rot=(Math.abs(deg)%180===90);
      const out=createCanvas(rot?h:w,rot?w:h);const x=out.getContext('2d');
      x.translate(out.width/2,out.height/2);x.rotate(r);x.drawImage(src,-w/2,-h/2);return out;
    }
    function debug(t){document.getElementById('debugInfo').textContent=t||''}

    /* ===== Preprocesado: gris + contraste + sharpen ===== */
    function preprocessSoft(canvas){ // escala gris + leve boost contraste
      const ctx=canvas.getContext('2d'),img=ctx.getImageData(0,0,canvas.width,canvas.height),d=img.data;
      for(let i=0;i<d.length;i+=4){let g=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]; g=(g-10)*1.18; g=Math.max(0,Math.min(255,g)); d[i]=d[i+1]=d[i+2]=g;}
      ctx.putImageData(img,0,0); return canvas;
    }
    function convolveSharpen(canvas){ // kernel sharpen 3x3
      const w=canvas.width,h=canvas.height,ctx=canvas.getContext('2d');
      const src=ctx.getImageData(0,0,w,h),d=src.data,out=ctx.createImageData(w,h),o=out.data;
      const k=[0,-1,0,-1,5,-1,0,-1,0];
      for(let y=1;y<h-1;y++)for(let x=1;x<w-1;x++){
        let r=0,g=0,b=0,ki=0;
        for(let j=-1;j<=1;j++)for(let i=-1;i<=1;i++){const idx=((y+j)*w+(x+i))*4,kval=k[ki++]; r+=d[idx]*kval; g+=d[idx+1]*kval; b+=d[idx+2]*kval;}
        const di=(y*w+x)*4; o[di]=Math.max(0,Math.min(255,r)); o[di+1]=Math.max(0,Math.min(255,g)); o[di+2]=Math.max(0,Math.min(255,b)); o[di+3]=255;
      }
      ctx.putImageData(out,0,0); return canvas;
    }

    /* ===== Deskew por barrido y crop a contenido ===== */
    function projectionScore(rot){ // varianza de proyecci√≥n horizontal
      const w=rot.width,h=rot.height,ctx=rot.getContext('2d'),img=ctx.getImageData(0,0,w,h).data,sum=new Float32Array(h);
      for(let y=0;y<h;y++){let acc=0; for(let x=0;x<w;x++){acc+=img[(y*w+x)*4]} sum[y]=acc;}
      let mean=0; for(let y=0;y<h;y++) mean+=sum[y]; mean/=h;
      let v=0; for(let y=0;y<h;y++){const d=sum[y]-mean; v+=d*d;} return v/h;
    }
    function deskewBySweep(canvas){ // barrido fino ¬±7¬∞
      let best=canvas, bestScore=-1, bestAngle=0;
      for(let a=-7;a<=7;a+=0.5){const r=drawRotated(canvas,a);const s=projectionScore(r);if(s>bestScore){bestScore=s;best=r;bestAngle=a;}}
      debug(`Rotaci√≥n fija: -90¬∞ | Deskew: ${bestAngle.toFixed(1)}¬∞`); return best;
    }
    function cropToContent(canvas, threshold=250){ // elimina bordes blancos/negros
      const w=canvas.width,h=canvas.height,ctx=canvas.getContext('2d'),img=ctx.getImageData(0,0,w,h).data;
      let top=0,bottom=h-1,left=0,right=w-1;
      for(let y=0;y<h;y++){let ok=false;for(let x=0;x<w;x++){if(img[(y*w+x)*4]<threshold){ok=true;break}} if(ok){top=y;break}}
      for(let y=h-1;y>=0;y--){let ok=false;for(let x=0;x<w;x++){if(img[(y*w+x)*4]<threshold){ok=true;break}} if(ok){bottom=y;break}}
      for(let x=0;x<w;x++){let ok=false;for(let y=0;y<h;y++){if(img[(y*w+x)*4]<threshold){ok=true;break}} if(ok){left=x;break}}
      for(let x=w-1;x>=0;x--){let ok=false;for(let y=0;y<h;y++){if(img[(y*w+x)*4]<threshold){ok=true;break}} if(ok){right=x;break}}
      const cw=Math.max(1,right-left+1),ch=Math.max(1,bottom-top+1);
      const out=createCanvas(cw,ch); out.getContext('2d').drawImage(canvas,left,top,cw,ch,0,0,cw,ch); return out;
    }

    /* ===== Config OCR (rango vertical y columnas) ===== */
    const Y_TABLE=[0.20,0.93]; // recorte vertical fino v4.8.7
    const COLS_PCT={numero:[0.03,0.14],descripcion:[0.22,0.80],cantidad:[0.86,0.97]};

    /* ===== Utils OCR ===== */
    function cleanLines(t){return t.split(/\n+/).map(s=>s.replace(/[|‚Ä¢¬∑‚óè]/g,'').trim()).filter(Boolean);}
    function toNumericOrBlank(s){const m=s.replace(/[^\d\-.,]/g,'').match(/\d+([.,]\d+)?/g);return m?m[m.length-1]:'';}
    function filterHeaders(s){return !/^(cliente|moneda|fecha|forma de pago|comentarios|orden|vendedor|ruc|u\.m\.?|um)$/i.test(s);}

    /* ===== Render tabla ===== */
    function renderTable(nRaw,dRaw,cRaw){
      let n=cleanLines(nRaw).filter(l=>/^\d+$/.test(l));
      let d=cleanLines(dRaw).filter(filterHeaders);
      let c=cleanLines(cRaw).map(toNumericOrBlank);
      const rows=Math.max(n.length,d.length,c.length),tb=document.querySelector('#tablaOCR tbody');tb.innerHTML='';
      for(let i=0;i<rows;i++){const num=n[i]||'',desc=d[i]||'',cant=c[i]||''; if(!desc)continue;
        const tr=document.createElement('tr'); tr.innerHTML=`<td>${num}</td><td>${desc}</td><td>${cant}</td>`; tb.appendChild(tr);}
    }

    /* ===== OCR regi√≥n (por columna) ===== */
    async function ocrRegion(canvas,x1,x2,y1,y2,lang='spa+eng'){
      const w=canvas.width,h=canvas.height;
      const rx=Math.floor(x1*w),ry=Math.floor(y1*h),rw=Math.floor((x2-x1)*w),rh=Math.floor((y2-y1)*h);
      const r=createCanvas(rw,rh); r.getContext('2d').drawImage(canvas,rx,ry,rw,rh,0,0,rw,rh);

      // binarizaci√≥n simple por columna (reduce ruido de l√≠neas)
      const ctx=r.getContext('2d'),img=ctx.getImageData(0,0,rw,rh),d=img.data;
      for(let i=0;i<d.length;i+=4){const g=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]; const v=g>180?255:0; d[i]=d[i+1]=d[i+2]=v;}
      ctx.putImageData(img,0,0);

      const {data:{text}}=await Tesseract.recognize(r,lang,{logger:m=>{if(m.status==='recognizing text')debug('OCR '+Math.round(m.progress*100)+'%');}});
      return text.trim();
    }

    /* ===== OCR principal (usa Y_TABLE y columnas) ===== */
    async function detectarTablaYCortarColumnas(c){
      const [y1,y2]=Y_TABLE;
      const [nx1,nx2]=COLS_PCT.numero,[dx1,dx2]=COLS_PCT.descripcion,[cx1,cx2]=COLS_PCT.cantidad;
      const [tN,tD,tC]=await Promise.all([
        ocrRegion(c,nx1,nx2,y1,y2),
        ocrRegion(c,dx1,dx2,y1,y2),
        ocrRegion(c,cx1,cx2,y1,y2)
      ]);
      renderTable(tN,tD,tC);
      debug('OCR v4.8.7 completado.');
    }

    /* ===== Guardado/descarga de previa ===== */
    function savePreviewToLocalStorage(canvas){
      try{localStorage.setItem('previa_ocr', canvas.toDataURL('image/jpeg',0.92));}catch(e){console.warn('No se pudo guardar previa',e);}
    }
    function downloadPreview(){
      const d=localStorage.getItem('previa_ocr'); if(!d){alert('No hay previa guardada.');return;}
      const a=document.createElement('a'); a.href=d; a.download='previa_ocr.jpg'; a.click();
    }
    document.getElementById('btnDownload').onclick=downloadPreview;

    /* ===== Pipeline completo ===== */
    async function processCanvas(base){
      // 1) Rotaci√≥n fija -90¬∞ (calibraci√≥n c√°mara trasera horizontal bot√≥n vol. arriba)
      base = drawRotated(base, -90);
      // 2) Preprocesado gris/contraste
      base = preprocessSoft(base);
      // 3) Deskew (endereza) y crop a contenido para centrar
      base = deskewBySweep(base);
      base = cropToContent(base, 245);
      // 4) Sharpen (mejor bordes texto)
      base = convolveSharpen(base);
      // 5) Vista previa + guardado
      putCanvas(base);
      savePreviewToLocalStorage(base);
      // 6) OCR columnas
      await detectarTablaYCortarColumnas(base);
    }

    /* ===== Limpiar ===== */
    document.getElementById('btnClear').onclick=()=>{
      const c=document.getElementById('canvas'); c.width=1; c.height=1; c.getContext('2d').clearRect(0,0,1,1);
      document.querySelector('#tablaOCR tbody').innerHTML=''; debug('');
      localStorage.removeItem('previa_ocr');
    };

    /* ===== Subir imagen (fallback si no hay c√°mara) ===== */
    document.getElementById('file').addEventListener('change',e=>{
      const f=e.target.files?.[0]; if(!f) return;
      const img=new Image(); const url=URL.createObjectURL(f);
      img.onload=async()=>{
        const c=createCanvas(img.naturalWidth||img.width,img.naturalHeight||img.height);
        c.getContext('2d').drawImage(img,0,0,c.width,c.height); URL.revokeObjectURL(url);
        toggleLoading(true); try{await processCanvas(c);}catch(err){alert('Error procesando imagen.');console.error(err);} finally{toggleLoading(false);}
      }; img.src=url;
    });

    /* ===== C√°mara (UI + mapeo exacto del marco verde) ===== */
    let stream=null;
    document.getElementById('fileBtn').onclick=openCameraModal;
    function openCameraModal(){ startCamera().catch(()=>document.getElementById('file').click()); }

    async function startCamera(){
      const modal=ensureCamUI(); modal.style.display='flex';
      try{
        stream=await navigator.mediaDevices.getUserMedia({
          video:{facingMode:{ideal:'environment'},width:{ideal:1920},height:{ideal:1080}},
          audio:false
        });
      }catch(e){ modal.style.display='none'; throw e; }
      const v=document.getElementById('video'); v.srcObject=stream; await v.play();
    }
    function stopCamera(){ if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;} const m=document.getElementById('cameraModal'); if(m) m.style.display='none'; }

    function overlayRectToVideoPixels(videoEl, overlayRect){
      // Mapea el rect√°ngulo del overlay (CSS) a p√≠xeles del sensor (object-fit: cover)
      const vw=videoEl.videoWidth, vh=videoEl.videoHeight;
      const rectVideo=videoEl.getBoundingClientRect();
      const scale=Math.max(rectVideo.width/vw, rectVideo.height/vh);
      const dispW=vw*scale, dispH=vh*scale;
      const offsetX=(dispW-rectVideo.width)/2, offsetY=(dispH-rectVideo.height)/2;
      const x_on_disp=(overlayRect.left-rectVideo.left)+offsetX;
      const y_on_disp=(overlayRect.top-rectVideo.top)+offsetY;
      const pxX=x_on_disp/dispW*vw, pxY=y_on_disp/dispH*vh, pxW=overlayRect.width/dispW*vw, pxH=overlayRect.height/dispH*vh;
      return {sx:pxX, sy:pxY, sw:pxW, sh:pxH};
    }

    function ensureCamUI(){
      let m=document.getElementById('cameraModal'); if(m) return m;
      m=document.createElement('div'); m.id='cameraModal';
      m.innerHTML=`<div class="cam-wrap">
          <video id="video" playsinline></video>
          <div class="crop-box" id="cropBox"></div>
          <div class="hint">Alinee la tabla dentro del marco verde (se captura exactamente esa zona)</div>
          <div class="cam-controls">
            <button id="snapBtn">üì∑ Capturar</button>
            <button id="closeBtn" class="ghost">Cerrar</button>
          </div>
        </div>`;
      document.body.appendChild(m);
      m.querySelector('#closeBtn').onclick=()=>stopCamera();
      m.querySelector('#snapBtn').onclick=async()=>{
        const v=document.getElementById('video'), box=document.getElementById('cropBox');
        const r=box.getBoundingClientRect(); const {sx,sy,sw,sh}=overlayRectToVideoPixels(v,r);
        // Captura de regi√≥n EXACTA dentro del marco
        const full=createCanvas(v.videoWidth,v.videoHeight);
        full.getContext('2d').drawImage(v,0,0,full.width,full.height);
        const roi=createCanvas(sw,sh);
        roi.getContext('2d').drawImage(full,sx,sy,sw,sh,0,0,roi.width,roi.height);
        stopCamera();
        toggleLoading(true);
        try{ await processCanvas(roi); }catch(e){ alert('Error procesando imagen.'); console.error(e); }
        finally{ toggleLoading(false); }
      };
      return m;
    }
  </script>
</body>
</html>
