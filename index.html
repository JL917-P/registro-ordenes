<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Smart OCR v4.1 ‚Äì Calidad Sede Villa</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icons/icon-192.png" type="image/png"/>
<meta name="theme-color" content="#0e141b"/>
<style>
  :root{--bg:#0b1220;--card:#101922;--line:#1f2a37;--ink:#eaf2ff;--muted:#a9b6c5;--brand:#4cc9f0;--ok:#22c55e;--err:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter}
  header{position:sticky;top:0;z-index:10;background:#0b1220cc;backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .wrap{max-width:980px;margin:0 auto;padding:14px}
  h1{margin:6px 0 2px;font-size:19px}
  .sub{color:var(--muted);font-size:13px;margin-bottom:8px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;margin-top:12px}
  button{appearance:none;border:1px solid transparent;background:var(--brand);color:#071018;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;margin-right:8px}
  .ghost{background:transparent;border:1px solid var(--line);color:var(--ink)}
  .ok{background:var(--ok);color:#06140a}
  .danger{background:var(--err);color:white}
  input[type=file]{display:none}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .cols{display:grid;grid-template-columns:1fr 2fr 1fr;gap:10px}
  .chip{font-size:12px;color:var(--muted);background:#0b1118;border:1px solid var(--line);padding:6px 8px;border-radius:999px;display:inline-block}
  .list{display:grid;gap:10px}
  .item{background:#0b1118;border:1px solid var(--line);padding:10px;border-radius:12px}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#132235;border:1px solid var(--line)}
  .mini{font-size:12px;color:var(--muted)}
  .drop{border:2px dashed #2a394a;border-radius:12px;padding:8px}
  canvas{max-width:100%;border:1px solid var(--line);border-radius:12px}
  .loader{display:none;align-items:center;gap:8px}
  .spin{width:16px;height:16px;border-radius:50%;border:2px solid #29425a;border-top-color:var(--brand);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  @media(max-width:860px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Smart OCR v4.1 ‚Äì Calidad Sede Villa</h1>
    <div class="sub">Corta <b>N¬∞</b>, <b>Descripci√≥n</b> y <b>Cant.</b> con OpenCV.js y hace OCR por columna (Tesseract.js, espa√±ol). <b>Detecci√≥n autom√°tica</b> al subir/tomar foto. Drag & drop en PC.</div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap">
      <div>
        <label class="ghost" for="file">üì∑ Tomar foto / Subir imagen</label>
        <input id="file" type="file" accept="image/*" capture="environment"/>
        <button id="btnOCR" class="ghost" disabled>üîé OCR por columnas</button>
        <button id="btnClear" class="ghost">üóëÔ∏è Limpiar</button>
      </div>
      <div class="loader" id="loader"><span class="spin"></span><span>Procesando‚Ä¶</span></div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="drop" id="drop">
        <div class="chip">Vista previa (con autocorrecci√≥n leve)</div>
        <canvas id="canvas" aria-label="Vista previa"></canvas>
        <div class="mini">Tip: encuadra la <b>tabla</b>. Arrastra una imagen aqu√≠ (PC) o usa la c√°mara (m√≥vil).</div>
      </div>
      <div>
        <div class="chip">Recortes de columnas</div>
        <div class="cols" style="margin-top:8px">
          <div><div class="mini">Col 1 ‚Ä¢ N¬∞</div><canvas id="cCol1"></canvas></div>
          <div><div class="mini">Col 3 ‚Ä¢ Descripci√≥n</div><canvas id="cCol3"></canvas></div>
          <div><div class="mini">Col 5 ‚Ä¢ Cant.</div><canvas id="cCol5"></canvas></div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <span id="colInfo" class="badge">Columnas: ‚Äì</span>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="chip">Resultados</div>
    <div id="results" class="list" style="margin-top:8px"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="btnExportJSON" class="ok" disabled>‚¨áÔ∏è Exportar JSON</button>
      <button id="btnExportCSV" class="ok" disabled>‚¨áÔ∏è Exportar CSV</button>
      <span id="count" class="badge">0 √≠tems</span>
    </div>
    <div class="mini" id="orderInfo">N¬∞ de Orden: ‚Äì</div>
  </section>

  <p class="mini">Privacidad: todo se procesa <b>en tu navegador</b> (OpenCV.js + Tesseract.js). No se sube ninguna imagen.</p>
</main>

<!-- OpenCV.js y Tesseract.js -->
<script async src="https://docs.opencv.org/4.x/opencv.js" onload="cvOnReady()"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
/* ====== refs ====== */
const $ = q => document.querySelector(q);
const file = $('#file'), drop = $('#drop');
const canvas = $('#canvas'), ctx = canvas.getContext('2d');
const c1 = $('#cCol1'), c3 = $('#cCol3'), c5 = $('#cCol5');
const resultsEl = $('#results'), countBadge = $('#count'), orderInfo = $('#orderInfo');
const btnOCR = $('#btnOCR'), btnClear = $('#btnClear');
const btnExportJSON = $('#btnExportJSON'), btnExportCSV = $('#btnExportCSV');
const loader = $('#loader'), colInfo = $('#colInfo');

let cvReady=false, srcImage=null, tableROI=null, colBounds=null, extracted=[], orderNo='';

function cvOnReady(){ cv['onRuntimeInitialized']=()=>{ cvReady=true; }}

/* ====== drag & drop ====== */
['dragover','dragenter'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault(); drop.style.borderColor='#4cc9f0'}));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault(); drop.style.borderColor='#2a394a'}));
drop.addEventListener('drop', async e=>{
  const f = [...e.dataTransfer.files].find(x=>/^image\//.test(x.type));
  if (f) await loadAndProcess(f); // AUTO
});

/* ====== file input ====== */
file.addEventListener('change', async ()=>{
  if(!file.files?.length) return;
  await loadAndProcess(file.files[0]); // AUTO
});

btnClear.addEventListener('click', ()=>{
  file.value=''; ctx.clearRect(0,0,canvas.width,canvas.height);
  [c1,c3,c5].forEach(c=>{c.width=0;c.height=0});
  resultsEl.innerHTML=''; setCount(0); extracted=[]; btnOCR.disabled=true;
  colInfo.textContent='Columnas: ‚Äì'; orderNo=''; orderInfo.textContent='N¬∞ de Orden: ‚Äì';
});

/* ====== flujo AUTO: cargar ‚Üí detectar/cortar ====== */
async function loadAndProcess(f){
  toggleLoading(true);
  try{
    const img = await readImage(f);
    drawBase(img);
    srcImage = img;

    // esperar OpenCV si a√∫n no carg√≥
    await waitFor(()=>cvReady, 8000);

    const res = detectTableAndColumns(canvas);
    tableROI = res.roi; colBounds = res.cols;

    cropToCanvas(canvas, c1, tableROI, colBounds.x1, colBounds.x3); // N¬∞
    cropToCanvas(canvas, c3, tableROI, colBounds.x3, colBounds.x5); // Descripci√≥n
    cropToCanvas(canvas, c5, tableROI, colBounds.x5, colBounds.xEnd); // Cant
    colInfo.textContent = `Columnas ‚úì  N¬∞:${colBounds.x1}-${colBounds.x3}  Desc:${colBounds.x3}-${colBounds.x5}  Cant:${colBounds.x5}-${colBounds.xEnd}`;
    btnOCR.disabled = false;
  }catch(err){
    alert('No se pudo preparar la tabla. Intenta encuadrar mejor la tabla.');
    console.error(err);
  }finally{ toggleLoading(false); }
}

/* ====== OCR bot√≥n ====== */
btnOCR.addEventListener('click', async ()=>{
  if(btnOCR.disabled) return;
  toggleLoading(true);
  try{
    const [numsTxt, descTxt, qtyTxt, orderTxt] = await Promise.all([
      ocrCanvas(c1), ocrCanvas(c3), ocrCanvas(c5), ocrHeader(canvas)
    ]);
    orderNo = extractOrderNo(orderTxt) || '';
    if(orderNo) orderInfo.textContent = `N¬∞ de Orden: ${orderNo}`;
    const items = reconstructRows(numsTxt, descTxt, qtyTxt);
    renderItems(items); extracted = items;
    btnExportJSON.disabled = !items.length; btnExportCSV.disabled = !items.length; setCount(items.length);
  }catch(err){ alert('Error en OCR: '+err.message); console.error(err);
  }finally{ toggleLoading(false); }
});

/* ====== export ====== */
btnExportJSON.addEventListener('click', ()=>{
  const name = (orderNo? orderNo : 'items') + '.json';
  downloadFile(name, JSON.stringify(extracted,null,2), 'application/json');
});
btnExportCSV.addEventListener('click', ()=>{
  const rows = [['numero','descripcion','cantidad'], ...extracted.map(r=>[r.numero, csvEsc(r.descripcion), r.cantidad])];
  const csv = rows.map(r=>r.join(',')).join('\n');
  const name = (orderNo? orderNo : 'items') + '.csv';
  downloadFile(name, csv, 'text/csv');
});

/* ====== util ====== */
function readImage(file){ return new Promise((res,rej)=>{const im=new Image();im.onload=()=>res(im);im.onerror=rej;im.src=URL.createObjectURL(file);}); }
function setCount(n){ countBadge.textContent = `${n} √≠tems`; }
function toggleLoading(on){ loader.style.display = on ? 'flex' : 'none'; }
function csvEsc(s){ return /[",\n]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s; }
function waitFor(fn, ms){ return new Promise((res,rej)=>{const t0=performance.now();(function loop(){ if(fn()) return res(); if(performance.now()-t0>ms) return rej(new Error('timeout')); requestAnimationFrame(loop) })();}); }

/* ====== dibujo base + orientaci√≥n ====== */
function drawBase(img){
  const maxW = 1700;
  const ln = Math.max(img.naturalWidth, img.naturalHeight);
  const scale = Math.min(1, maxW/ln);
  let W = Math.round(img.naturalWidth*scale), H = Math.round(img.naturalHeight*scale);

  // Heur√≠stica de orientaci√≥n
  const rotate = (W < H * 0.8);
  if(!rotate){ canvas.width=W; canvas.height=H; ctx.drawImage(img,0,0,W,H); }
  else{ canvas.width=H; canvas.height=W; ctx.save(); ctx.translate(canvas.width,0); ctx.rotate(Math.PI/2); ctx.drawImage(img,0,0,W,H); ctx.restore(); }

  // Mejora leve de contraste
  const id = ctx.getImageData(0,0,canvas.width,canvas.height);
  const d = id.data; for(let i=0;i<d.length;i+=4){ const y=0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2]; const v=Math.max(0,Math.min(255, ((y/255-0.5)*1.2+0.5)*255 )); d[i]=d[i+1]=d[i+2]=v; }
  ctx.putImageData(id,0,0);
}

/* ====== OpenCV: detectar tabla + columnas ====== */
function detectTableAndColumns(cnv){
  const src = cv.imread(cnv);
  const gray = new cv.Mat(); cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
  const blr = new cv.Mat(); cv.GaussianBlur(gray, blr, new cv.Size(3,3), 0);
  const bin = new cv.Mat(); cv.adaptiveThreshold(blr, bin, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY_INV, 23, 7);

  const horiz = new cv.Mat.zeros(bin.rows, bin.cols, cv.CV_8UC1);
  const vert  = new cv.Mat.zeros(bin.rows, bin.cols, cv.CV_8UC1);
  let size = Math.floor(bin.cols/60); size = Math.max(10, Math.min(40, size));
  const hK = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(size,1));
  const vK = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(1,size));
  cv.erode(bin, horiz, hK); cv.dilate(horiz, horiz, hK);
  cv.erode(bin, vert,  vK); cv.dilate(vert,  vK);

  const tableMask = new cv.Mat(); cv.addWeighted(horiz,0.5,vert,0.5,0,tableMask);
  const contours = new cv.MatVector(); const hierarchy = new cv.Mat();
  cv.findContours(tableMask, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

  // ---- ROI robusto (evita undefined) ----
  let roi;
  if (contours.size()===0){
    const x = Math.round(cnv.width*0.02), w = Math.round(cnv.width*0.96);
    const y = Math.round(cnv.height*0.20), h = Math.round(cnv.height*0.62);
    roi = {x,y,w,h};
  } else {
    let best=null, areaMax=0;
    for (let i=0;i<contours.size();i++){
      const r=cv.boundingRect(contours.get(i));
      const a=r.width*r.height; if(a>areaMax){areaMax=a;best=r;}
    }
    roi = {x:Math.max(0,best.x-4), y:Math.max(0,best.y-4),
           w:Math.min(src.cols-best.x+8,best.width+8),
           h:Math.min(src.rows-best.y+8,best.height+8)};
  }
  if(!roi){ roi={x:Math.round(cnv.width*0.05), y:Math.round(cnv.height*0.20), w:Math.round(cnv.width*0.90), h:Math.round(cnv.height*0.60)}; }

  // L√≠neas verticales dentro del ROI
  const roiMat = bin.roi(new cv.Rect(roi.x, roi.y, roi.w, roi.h));
  const v2 = new cv.Mat(); cv.erode(roiMat, v2, vK); cv.dilate(v2, v2, vK);

  const proj = new Array(roi.w).fill(0);
  for (let x=0;x<roi.w;x++){ for (let y=0;y<roi.h;y++){ proj[x]+= (v2.ucharPtr(y,x)[0]>0)?1:0; } }
  const maxP = Math.max(...proj)||1; const thr = maxP*0.6;
  let peaks=[]; for(let x=1;x<roi.w-1;x++){ if(proj[x]>thr && proj[x]>=proj[x-1] && proj[x]>=proj[x+1]) peaks.push(x); }
  // fusionar picos cercanos
  const merged=[]; if(peaks.length){ let acc=[peaks[0]]; for(let i=1;i<peaks.length;i++){ if(peaks[i]-acc[acc.length-1] < 15) acc.push(peaks[i]); else { merged.push(Math.round(acc.reduce((a,b)=>a+b,0)/acc.length)); acc=[peaks[i]]; } } if(acc.length) merged.push(Math.round(acc.reduce((a,b)=>a+b,0)/acc.length)); }
  merged.sort((a,b)=>a-b);

  let cols;
  if(merged.length>=6){
    const xLeft = roi.x + merged[0];
    const xC3Ini = roi.x + merged[2];   // saltamos C√≥digo
    const xC5Ini = roi.x + merged[5];   // Cantidad
    const xRight = roi.x + roi.w - 4;
    cols = {x1:xLeft, x3:xC3Ini, x5:xC5Ini, xEnd:xRight};
  } else {
    // Proporciones calibradas a tu formato
    const x1 = roi.x + Math.round(roi.w*0.03);
    const x3 = roi.x + Math.round(roi.w*0.27);
    const x5 = roi.x + Math.round(roi.w*0.80);
    const xEnd = roi.x + roi.w - 6;
    cols = {x1,x3,x5,xEnd};
  }

  [src,gray,blr,bin,horiz,vert,tableMask,contours,hierarchy,roiMat,v2].forEach(m=>{try{m.delete()}catch{}});
  return {roi, cols};
}

function cropToCanvas(srcCanvas, dstCanvas, roi, xStartAbs, xEndAbs){
  const sx = xStartAbs, sw = Math.max(8, xEndAbs-xStartAbs);
  const sy = roi.y, sh = roi.h;
  dstCanvas.width = sw; dstCanvas.height = sh;
  const dctx = dstCanvas.getContext('2d');
  dctx.drawImage(srcCanvas, sx, sy, sw, sh, 0, 0, sw, sh);
}

/* ====== OCR ====== */
async function ocrCanvas(cnv){
  const blob = await new Promise(res=>cnv.toBlob(res,'image/png'));
  const {data} = await Tesseract.recognize(blob, 'spa', {logger:m=>{}});
  return data.text || '';
}
async function ocrHeader(fullCanvas){
  const H = Math.round(fullCanvas.height*0.20);
  const tmp = document.createElement('canvas'); tmp.width = fullCanvas.width; tmp.height = H;
  tmp.getContext('2d').drawImage(fullCanvas, 0, 0, fullCanvas.width, H, 0, 0, fullCanvas.width, H);
  const blob = await new Promise(res=>tmp.toBlob(res,'image/png'));
  const {data} = await Tesseract.recognize(blob,'spa',{logger:m=>{}});
  return data.text || '';
}
function extractOrderNo(t){
  const m = (t||'').toUpperCase().match(/I?ILMVR\d{8,}/);
  return m ? m[0] : '';
}

/* ====== reconstrucci√≥n ====== */
function splitClean(t){ return (t||'').replace(/\r/g,'\n').replace(/[|¬∑‚Ä¢]/g,' ').split('\n').map(s=>s.trim()).filter(Boolean); }
function cleanDesc(s){
  let d = s.toUpperCase();
  d = d.replace(/P[R]?[D]?\d{4,6}/g,' ')
       .replace(/\b(SACO|SACOS|BLS|UND|UM)\b/g,' ')
       .replace(/[^\w√Å√â√ç√ì√ö√ë√ú\s]/g,' ')
       .replace(/\s{2,}/g,' ').trim();
  d = d.replace(/ARROZPILADO/g,'ARROZ PILADO')
       .replace(/PLADO|PLAGO/g,'PILADO')
       .replace(/ANEJO|A[E|I]JO/g,'ANEJO')
       .replace(/CHAL[A|√Å]N|CHAIAN|CHA LAN/g,'CHALAN')
       .replace(/\sX(?=\d)/,' X ');
  if(!/KG/.test(d)) return '';
  return d;
}
function reconstructRows(txtNums, txtDesc, txtQty){
  const nums = splitClean(txtNums).map(s=>parseInt(s.match(/^\d{1,3}/)?.[0]||'')).filter(Number.isInteger);
  const desc = splitClean(txtDesc).map(cleanDesc).filter(Boolean);
  const qtys = splitClean(txtQty).map(s=>parseInt((s.match(/\d{1,3}$/)||[''])[0])).filter(n=>Number.isInteger(n)&&n<=300);
  const L = Math.min(nums.length, desc.length, qtys.length);
  const out=[]; for(let i=0;i<L;i++){ out.push({numero: nums[i] ?? (i+1), descripcion: desc[i], cantidad: qtys[i]}); }
  out.sort((a,b)=>(a.numero||0)-(b.numero||0)); return out;
}

/* ====== render ====== */
function renderItems(items){
  resultsEl.innerHTML='';
  if(!items.length){ resultsEl.innerHTML='<div class="item">No se detectaron filas v√°lidas.</div>'; return; }
  for(const r of items){
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`<b>N¬∞:</b> ${r.numero}<br><b>Desc:</b> ${r.descripcion}<br><b>Cant:</b> ${r.cantidad}`;
    resultsEl.appendChild(el);
  }
}

/* ====== helpers ====== */
function downloadFile(name, content, mime){
  const blob = new Blob([content], {type:mime});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name;
  document.body.appendChild(a); a.click(); a.remove();
}
</script>
</body>
</html>
