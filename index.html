<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OCR ‚Äì √ìrdenes de Venta (Smart v4.9.2)</title>
<style>
:root{
  --accent:#00ff88;
  --accent-drag:#3aff9f;
  --bg:#0b1220;
  --text:#f5f5f5;
  --muted:#aaa;
}
body{
  font-family:Arial,Helvetica,sans-serif;
  background:var(--bg);
  color:var(--text);
  margin:0;
  text-align:center;
}
header{padding:12px;}
button{
  background:var(--accent);
  color:#000;
  border:none;
  border-radius:10px;
  padding:10px 16px;
  margin:6px;
  font-size:15px;
  cursor:pointer;
}
button.ghost{
  background:transparent;
  border:1px solid var(--accent);
  color:var(--accent);
}
video{
  width:100%;
  height:auto;
  object-fit:cover;
  border-radius:8px;
}
#cameraBox{
  position:relative;
  display:inline-block;
  margin-top:10px;
}
#overlay{
  position:absolute;
  top:0;left:0;width:100%;height:100%;
  pointer-events:none;
}
#frame{
  position:absolute;
  border:3px solid var(--accent);
  border-radius:12px;
  width:92%;
  height:80%;
  top:10%;
  left:4%;
  box-sizing:border-box;
  transition:border-color 0.2s ease;
}
#handle{
  position:absolute;
  bottom:-8px;left:50%;
  width:80px;height:10px;
  background:rgba(200,200,200,0.7);
  border-radius:5px;
  cursor:ns-resize;
  transform:translateX(-50%);
  transition:background 0.2s ease;
}
#canvasPreview{
  border:1px dashed #777;
  margin-top:10px;
  max-width:90%;
}
table{
  margin:20px auto;
  border-collapse:collapse;
  width:95%;
  max-width:800px;
}
th,td{
  border:1px solid #777;
  padding:6px;
  font-size:13px;
  text-align:left;
}
th{background:#111;color:#eee;}
footer{margin:20px;font-size:12px;color:var(--muted);}
</style>
</head>
<body>

<header>
  <h2>OCR ‚Äì √ìrdenes de Venta (Smart v4.9.2)</h2>
  <div>Versi√≥n 4.9.2 ‚Äì Marco inferior ajustable + OCR 2 columnas</div>
</header>

<main>
  <div>
    <button id="btnStart">üì∑ Tomar foto / Subir imagen</button>
    <button id="btnClear" class="ghost">üßπ Limpiar</button>
    <button id="btnDownload" class="ghost">‚¨áÔ∏è Descargar previa</button>
  </div>

  <div id="cameraBox">
    <video id="video" autoplay playsinline></video>
    <div id="overlay"><div id="frame"><div id="handle"></div></div></div>
  </div>

  <div style="margin-top:10px;">
    <button id="btnCapture">üì∏ Capturar</button>
  </div>

  <h3>Vista previa (centrada y horizontal)</h3>
  <canvas id="canvasPreview"></canvas>

  <h3>Tabla OCR generada</h3>
  <table id="tablaOCR">
    <thead><tr><th>Descripci√≥n</th><th>Cantidades</th></tr></thead>
    <tbody></tbody>
  </table>
</main>

<footer>Smart OCR Horizontal ¬© 2025 Calidad Sede Villa</footer>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
<script>
// ================= CONFIGURACI√ìN DE C√ÅMARA =================
const video=document.getElementById('video');
const frame=document.getElementById('frame');
const handle=document.getElementById('handle');
const canvasPrev=document.getElementById('canvasPreview');
let stream,frameHeight=0.8,resizing=false,startY=0;

// Iniciar c√°mara trasera horizontal
async function startCamera(){
  try{
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080}},
      audio:false
    });
    video.srcObject=stream;
  }catch(e){alert("No se pudo acceder a la c√°mara.");}
}

// Tirador inferior siempre visible (gris ‚Üí verde al arrastrar)
handle.addEventListener('mousedown',e=>{
  resizing=true;startY=e.clientY;
  handle.style.background=varAccent('--accent-drag');
});
window.addEventListener('mouseup',()=>{
  resizing=false;
  handle.style.background='rgba(200,200,200,0.7)';
});
window.addEventListener('mousemove',e=>{
  if(!resizing)return;
  const delta=(e.clientY-startY)/window.innerHeight;
  frameHeight=Math.max(0.4,Math.min(0.9,frameHeight+delta));
  frame.style.height=(frameHeight*100)+'%';
  startY=e.clientY;
});

// === Captura de √°rea dentro del marco ===
async function captureImage(){
  const w=video.videoWidth,h=video.videoHeight;
  if(!w||!h){alert("C√°mara no lista.");return;}
  const c=document.createElement('canvas');
  const ctx=c.getContext('2d');
  c.width=w;c.height=h;
  ctx.drawImage(video,0,0,w,h);

  // Recorte proporcional exacto al marco verde
  const fx=0.04*w;
  const fy=(1-frameHeight)/2*h;
  const fw=0.92*w;
  const fh=frameHeight*h;
  const rec=ctx.getImageData(fx,fy,fw,fh);

  const crop=document.createElement('canvas');
  crop.width=fw;crop.height=fh;
  crop.getContext('2d').putImageData(rec,0,0);

  canvasPrev.width=fw;canvasPrev.height=fh;
  canvasPrev.getContext('2d').drawImage(crop,0,0);

  localStorage.setItem('previa_ocr',canvasPrev.toDataURL('image/jpeg',0.92));
  await procesarOCR(crop);
}

// === OCR 2 columnas: Descripci√≥n + Cantidad ===
async function procesarOCR(canvas){
  const {data:{text}}=await Tesseract.recognize(canvas,'spa',{logger:m=>console.log(m.status)});
  const lineas=text.split('\n').map(l=>l.trim()).filter(Boolean);

  const data=lineas.map(l=>{
    const match=l.match(/(.*?)(\d{1,4})$/);
    if(match)return{desc:match[1].trim(),cant:match[2].trim()};
  }).filter(Boolean);

  const tbody=document.querySelector('#tablaOCR tbody');
  tbody.innerHTML="";
  data.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.desc}</td><td>${r.cant}</td>`;
    tbody.appendChild(tr);
  });
}

// === Descargar previa guardada ===
document.getElementById('btnDownload').onclick=()=>{
  const d=localStorage.getItem('previa_ocr');
  if(!d){alert("No hay vista previa guardada.");return;}
  const a=document.createElement('a');
  a.href=d;a.download='previa_ocr.jpg';
  a.click();
};

// === Botones ===
document.getElementById('btnStart').onclick=()=>startCamera();
document.getElementById('btnCapture').onclick=()=>captureImage();
document.getElementById('btnClear').onclick=()=>{
  const ctx=canvasPrev.getContext('2d');
  ctx.clearRect(0,0,canvasPrev.width,canvasPrev.height);
  document.querySelector('#tablaOCR tbody').innerHTML="";
  localStorage.removeItem('previa_ocr');
};

// === Cerrar c√°mara al salir ===
window.addEventListener('beforeunload',()=>{if(stream)stream.getTracks().forEach(t=>t.stop());});

// Funci√≥n auxiliar
function varAccent(v){return getComputedStyle(document.documentElement).getPropertyValue(v);}
</script>
</body>
</html>
