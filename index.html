<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>OCR ‚Äì √ìrdenes de Venta</title>
  <meta name="theme-color" content="#0e141b"/>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/icon-192.png" type="image/png"/>
  <style>
    :root{
      --bg:#0e141b; --card:#101922; --ink:#eaf2ff; --muted:#a9b6c5; --brand:#4cc9f0; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --line:#1f2a37; --chip:#0b1118; --accent:#8b5cf6;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220 0%,#0e141b 100%);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu;}
    header{position:sticky;top:0;z-index:20;background:#0b1220cc;backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
    .wrap{max-width:980px;margin:0 auto;padding:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    h1{margin:6px 0 2px;font-size:18px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    button,.btn{appearance:none;border:1px solid transparent;background:var(--brand);color:#071018;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .ghost{background:transparent;border-color:var(--line);color:var(--ink)}
    .ok{background:var(--ok);color:#05120a}
    input[type=file]{display:none}
    .chip{font-size:12px;color:var(--muted);background:var(--chip);border:1px solid var(--line);padding:6px 8px;border-radius:999px}
    .preview{display:grid;grid-template-columns:1fr;gap:12px}
    .cell{background:#0b1118;border:1px solid var(--line);padding:10px;border-radius:10px;min-height:40px}
    .num{font-variant-numeric:tabular-nums}
    .muted{color:var(--muted)}
    .list{display:grid;gap:8px}
    .item{display:grid;grid-template-columns:64px 1fr 96px;gap:10px;align-items:center;background:#0b1118;border:1px solid var(--line);padding:10px;border-radius:12px}
    .item input{width:100%;background:transparent;border:1px dashed #2a394a;border-radius:8px;color:var(--ink);padding:8px}
    .sep{height:1px;background:var(--line);margin:10px 0}
    .footer{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#132235;border:1px solid var(--line)}
    .hint{font-size:12px;color:var(--muted)}
    .loader{display:none;align-items:center;gap:8px}
    .spin{width:16px;height:16px;border-radius:50%;border:2px solid #29425a;border-top-color:var(--brand);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    @media(min-width:860px){.preview{grid-template-columns:1.1fr .9fr}}
    canvas{max-width:100%;border:1px solid var(--line);border-radius:12px}
    .mini{font-size:11px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>OCR ‚Äì √ìrdenes de Venta</h1>
      <div class="sub">Extrae <b>N¬∞</b>, <b>Descripci√≥n</b> y <b>Cantidad</b> desde una foto ‚Äî listo para Android v√≠a URL (HTTPS).</div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <div class="toolbar">
          <label for="file" class="btn">üì∑ Tomar foto / Subir imagen</label>
          <input id="file" type="file" accept="image/*" capture="environment" />
          <button id="btnProcess" class="ghost" disabled>üîé Procesar OCR</button>
          <button id="btnClear" class="ghost">üóëÔ∏è Limpiar</button>
        </div>
        <div class="loader" id="loader"><span class="spin"></span><span>Procesando‚Ä¶</span></div>
      </div>

      <div class="preview" style="margin-top:12px">
        <div>
          <div class="chip">Vista previa (auto-mejora de imagen)</div>
          <canvas id="canvas" class="mt" aria-label="Vista previa de la imagen"></canvas>
          <div class="mini">Sugerencia: toma la foto bien iluminada y lo m√°s perpendicular posible al documento.</div>
        </div>
        <div>
          <div class="chip">Resultados extra√≠dos (solo esta foto)</div>
          <div id="results" class="list" aria-live="polite"></div>
          <div class="footer">
            <button id="btnExportJSON" class="ok" disabled>‚¨áÔ∏è Exportar JSON</button>
            <button id="btnExportCSV" class="ok" disabled>‚¨áÔ∏è Exportar CSV</button>
            <span id="count" class="badge">0 √≠tems</span>
          </div>
        </div>
      </div>
    </section>

    <p class="hint">Privacidad: todo el procesamiento se hace <b>en tu navegador</b> con <code>Tesseract.js</code>; no se suben im√°genes a ning√∫n servidor.</p>
  </main>

  <!-- Tesseract.js (OCR en el navegador) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <script>
  const $ = (q) => document.querySelector(q);
  const file = $('#file');
  const canvas = $('#canvas');
  const ctx = canvas.getContext('2d');
  const btnProcess = $('#btnProcess');
  const btnClear = $('#btnClear');
  const resultsEl = $('#results');
  const loader = $('#loader');
  const btnExportJSON = $('#btnExportJSON');
  const btnExportCSV = $('#btnExportCSV');
  const countBadge = $('#count');

  let currentImage = null;
  let extracted = [];

  // PWA: registra service worker si est√° disponible
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    });
  }

  file.addEventListener('change', async () => {
    if (!file.files?.length) return;
    const img = await loadImage(file.files[0]);
    drawEnhanced(img); // preprocesa y muestra
    btnProcess.disabled = false;
  });

  btnClear.addEventListener('click', () => {
    file.value = '';
    ctx.clearRect(0,0,canvas.width,canvas.height);
    resultsEl.innerHTML = '';
    btnProcess.disabled = true;
    btnExportJSON.disabled = true;
    btnExportCSV.disabled = true;
    setCount(0);
  });

  btnProcess.addEventListener('click', async () => {
    if (!currentImage) return;
    toggleLoading(true);
    try{
      const blob = await canvasToBlob(canvas);
      const { data } = await Tesseract.recognize(blob, 'eng', { logger: m => {} });
      const cleanText = normalizeText(data.text);
      extracted = parseLines(cleanText);
      renderItems(extracted);
      btnExportJSON.disabled = extracted.length === 0;
      btnExportCSV.disabled = extracted.length === 0;
      setCount(extracted.length);
    }catch(err){
      alert('Error en OCR: ' + err.message);
      console.error(err);
    }finally{
      toggleLoading(false);
    }
  });

  btnExportJSON.addEventListener('click', () => {
    downloadFile('items.json', JSON.stringify(extracted, null, 2), 'application/json');
  });

  btnExportCSV.addEventListener('click', () => {
    const rows = [['numero','descripcion','cantidad'], ...extracted.map(r => [r.numero ?? '', escapeCSV(r.descripcion), r.cantidad ?? ''] )];
    const csv = rows.map(r => r.join(',')).join('\n');
    downloadFile('items.csv', csv, 'text/csv');
  });

  function setCount(n){ countBadge.textContent = `${n} √≠tems`; }
  function toggleLoading(on){ loader.style.display = on ? 'flex' : 'none'; }

  function loadImage(file){
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = URL.createObjectURL(file);
    });
  }

  function drawEnhanced(img){
    const maxW = 1600;
    const scale = Math.min(1, maxW / img.naturalWidth);
    const W = Math.round(img.naturalWidth * scale);
    const H = Math.round(img.naturalHeight * scale);
    canvas.width = W; canvas.height = H;
    ctx.drawImage(img, 0, 0, W, H);

    if (W > H * 1.4) {
      const tmp = document.createElement('canvas');
      tmp.width = H; tmp.height = W;
      const tctx = tmp.getContext('2d');
      tctx.translate(H, 0); tctx.rotate(Math.PI/2);
      tctx.drawImage(canvas, 0, 0);
      canvas.width = tmp.width; canvas.height = tmp.height;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(tmp, 0, 0);
    }

    const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const d = imgData.data;
    const contrast = 1.25;
    for (let i=0; i<d.length; i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      let y = 0.2126*r + 0.7152*g + 0.0722*b;
      y = ((y/255 - .5) * contrast + .5) * 255;
      const v = Math.max(0, Math.min(255, y));
      d[i]=d[i+1]=d[i+2]=v;
    }
    ctx.putImageData(imgData, 0, 0);
    currentImage = true;
  }

  function canvasToBlob(cnv){
    return new Promise(res => cnv.toBlob(res, 'image/png', 1));
  }

  function normalizeText(t){
    return t
      .replace(/[\t\r]+/g, '\n')
      .replace(/\u00A0/g, ' ')
      .replace(/[ ]{2,}/g, ' ')
      .split('\n')
      .map(s => s.trim())
      .filter(Boolean)
      .join('\n');
  }

  // Heur√≠stica: filas que empiezan con N¬∞ y terminan en cantidad entera
  function parseLines(text){
    const lines = text.split('\n');
    const out = [];
    for (let raw of lines){
      const line = raw.replace(/\s{2,}/g,' ').trim();
      if (!/^\d{1,3}(\s|\.)/.test(line)) continue;

      let tokens = line.split(' ').filter(Boolean);

      let numero = tokens.shift();
      if (!/^\d{1,3}$/.test(numero)){
        numero = (numero.match(/\d{1,3}/)||[])[0];
      }
      if (!numero) continue;

      let tail = tokens[tokens.length-1];
      if(!/^\d{1,4}$/.test(tail)) continue;
      const cantidad = parseInt(tail,10);
      tokens.pop();

      if (tokens.length){
        const maybeCode = tokens[0];
        const isCode = /^(?:[A-Z0-9]{5,}|\d{5,})$/.test(maybeCode);
        if (isCode) tokens.shift();
      }

      const UM = new Set(['SACO','SACOS','BLS','BOL','UND','UNID','CJ','PAQ','BL','KG','KGS','KG.']);
      tokens = tokens.filter(t => !UM.has(t.replace(/[^A-Z]/g,'')));

      tokens = tokens.filter(t => !/^(\d{1,3}(?:[\.,]\d{3})*|\d+)[\.,]\d{2}$/.test(t));

      let descripcion = tokens.join(' ').replace(/\s{2,}/g,' ').trim();
      if (descripcion.length < 3) continue;

      out.push({ numero: parseInt(numero,10), descripcion, cantidad });
    }
    out.sort((a,b)=>a.numero-b.numero);
    return out;
  }

  function renderItems(items){
    resultsEl.innerHTML = '';
    if (!items.length){
      resultsEl.innerHTML = '<div class="muted">No se detectaron filas v√°lidas. Revisa la foto o intenta nuevamente.</div>';
      return;
    }
    for (const row of items){
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `
        <div class="cell num"><b>N¬∞</b><br>${row.numero}</div>
        <div class="cell"><b>Descripci√≥n</b><br><span class="desc">${escapeHTML(row.descripcion)}</span></div>
        <div class="cell"><b>Cantidad</b><br><input type="number" min="0" step="1" value="${row.cantidad}" class="qty" /></div>
      `;
      const qty = el.querySelector('.qty');
      qty.addEventListener('input', (e)=>{
        const v = parseInt(e.target.value||'0',10);
        row.cantidad = isNaN(v)?0:v;
      });
      resultsEl.appendChild(el);
    }
  }

  function downloadFile(name, content, mime){
    const blob = new Blob([content], {type:mime});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function escapeHTML(s){
    return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
  }
  function escapeCSV(s){
    if (/[",\n]/.test(s)) return '"'+s.replace(/"/g,'""')+'"';
    return s;
  }
  </script>
</body>
</html>
